#pragma once

#include <stddef.h>
#include <stdio.h>
#include <sys/_pthreadtypes.h>
#include <sys/signal.h>
#include <sys/socket.h>
#include <sys/stat.h>
#include <sys/un.h>
#include <notify.hpp>
#include <unistd.h>
#include "dbg.hpp"
#include "dbg/dbg.hpp"
#include "elf/elf.hpp"
#include "hijacker/hijacker.hpp"
#include "backtrace.hpp"
#include <map>
#include <string>
#include <vector>

// Pad structures
#define ORBIS_PAD_BUTTON_CROSS 0x4000

typedef struct {
	uint32_t buttons;
	uint8_t leftStick_x;
	uint8_t leftStick_y;
	uint8_t rightStick_x;
	uint8_t rightStick_y;
	// ... autres champs
} OrbisPadData;

// GameStuff structure
struct GameStuff {
	uintptr_t scePadReadState;
	uintptr_t debugout;
	uintptr_t sceKernelLoadStartModule;
	uintptr_t sceKernelDlsym;
	uint64_t ASLR_Base = 0;
	char prx_path[256];
	int loaded = 0;
	uint64_t game_hash = 0;
	int frame_delay = 300;
	int frame_counter = 0;

	GameStuff(Hijacker &hijacker) noexcept;
};

// GameBuilder structure
struct GameBuilder {
	static constexpr size_t SHELLCODE_SIZE = 137;
	static constexpr size_t EXTRA_STUFF_ADDR_OFFSET = 2;
	uint8_t shellcode[256];
	void setExtraStuffAddr(uintptr_t addr) noexcept;
};

// Shellcode template
static constexpr GameBuilder BUILDER_TEMPLATE {
	0x48, 0xba, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x55, 0x41, 0x57, 0x41, 0x56, 0x53, 0x48, 0x83, 0xec, 0x18, 0x48, 0xb8, 0x48, 0x65, 0x6c, 0x6c,
	0x6f, 0x20, 0x66, 0x72, 0x48, 0x89, 0xd3, 0x49, 0x89, 0xf6, 0x41, 0x89, 0xff, 0x48, 0x89, 0x04,
	0x24, 0x48, 0xb8, 0x6f, 0x6d, 0x20, 0x42, 0x4f, 0x36, 0x00, 0x00, 0x48, 0x89, 0x44, 0x24, 0x08,
	0xff, 0x12, 0x89, 0xc5, 0x45, 0x85, 0xff, 0x7e, 0x39, 0x85, 0xed, 0x75, 0x35, 0x41, 0x80, 0x7e,
	0x4c, 0x00, 0x74, 0x2e, 0x83, 0xbb, 0x28, 0x01, 0x00, 0x00, 0x00, 0x75, 0x25, 0x48, 0x8d, 0x7b,
	0x28, 0x31, 0xf6, 0x31, 0xd2, 0x31, 0xc9, 0x45, 0x31, 0xc0, 0x45, 0x31, 0xc9, 0xff, 0x53, 0x10,
	0x48, 0x89, 0xe6, 0x31, 0xff, 0xff, 0x53, 0x08, 0xc7, 0x83, 0x28, 0x01, 0x00, 0x00, 0x01, 0x00,
	0x00, 0x00, 0x89, 0xe8, 0x48, 0x83, 0xc4, 0x18, 0x5b, 0x41, 0x5e, 0x41, 0x5f, 0x5d, 0xc3
};

// Config structures
struct PRXConfig {
	std::string path;
	int frame_delay;
};

struct GameInjectorConfig {
	std::map<std::string, std::vector<PRXConfig>> games; // TID -> liste de PRX
};

// Functions
void plugin_log(const char* fmt, ...);
bool Is_Game_Running(int &BigAppid, const char* title_id);
bool HookGame(UniquePtr<Hijacker> &hijacker, uint64_t aslr_base, const char* prx_path, int frame_delay);
GameInjectorConfig parse_injector_config();

extern "C" int sceSystemServiceKillApp(int, int, int, int);
extern "C" int sceSystemServiceGetAppId(const char *);
extern "C" int _sceApplicationGetAppId(int pid, int *appId);